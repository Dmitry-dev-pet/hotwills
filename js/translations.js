// ─── Config ─────────────────────────────────────────────────────────────
const LANG_KEY = 'mbx_lang';
const LANG_DEFAULT = 'en';
const LANG_VALID = ['ru', 'en', 'pt'];

const TRANSLATIONS = {
  ru: {
    loadJson: 'Загрузить JSON',
    loadFolder: 'Загрузить папку',
    loadImages: 'Загрузить картинки',
    addPhoto: 'Добавить фото',
    addPhotoAdded: '{n} фото добавлено',
    imagesLoaded: 'Сохранено картинок: {n}',
    folderImported: 'Папка загружена: {items} моделей, {images} картинок',
    folderJsonMissing: 'В выбранной папке не найден JSON',
    localImagesUnsupported: 'Браузер не поддерживает локальное хранилище картинок',
    sortByName: 'По названию',
    sortByCode: 'По коду',
    sortByYear: 'По году',
    editor: 'Редактор',
    loadJsonPrompt: 'Загрузите JSON',
    link: 'Ссылка',
    code: 'Код',
    year: 'Год',
    file: 'Файл',
    errorInvalidJson: 'Ошибка: неверный JSON',
    catalog: 'Каталог',
    preview: 'Превью',
    name: 'Название',
    copyJson: 'Копировать JSON',
    saveJson: 'Скачать JSON',
    modelNamePlaceholder: 'Название модели',
    yearPlaceholder: 'Год',
    codePlaceholder: 'Код',
    imagePlaceholder: '0.jpg',
    linkPlaceholder: 'https://...',
    noImage: 'нет',
    loadJsonFirst: 'Сначала загрузите JSON',
    jsonLoaded: 'JSON загружен',
    copiedToClipboard: 'Скопировано в буфер',
    fileDownloaded: 'Файл скачан',
    linkWord: 'ССЫЛКА',
    pageTitle: 'Каталог',
    searchPlaceholder: 'Поиск по названию, году, коду...',
    searchNoResults: 'Ничего не найдено',
    favorites: 'Избранное',
    noFavorites: 'Нет избранных',
    similarModelsBadge: 'Есть у других: {n}',
    similarModelsTitle: 'Есть у других пользователей: {n}',
    infographic: 'Инфографика',
    transpose: 'Транспонировать',
    yearModalTitle: 'Модели за {year} год',
    infographicModelCol: 'Модель',
    infographicYearCol: 'Год',
    infographicChartCount: 'шт',
    infographicChartLabel: 'Кол-во моделей за год',
    signIn: 'Войти',
    authorize: 'Авторизация',
    signUp: 'Регистрация',
    signOut: 'Выйти',
    viewUserCatalog: 'Открыть чужой каталог',
    viewOwnCatalog: 'Мой каталог',
    copyShareLink: 'Скопировать ссылку',
    catalogOwner: 'Каталог',
    catalogOwnerLoading: 'Загрузка...',
    catalogOwnerMine: 'Мой каталог',
    catalogOwnerNoData: 'Нет доступных каталогов',
    catalogOwnerOnlyMine: 'Пока доступен только ваш каталог',
    catalogOwnerLoadFailed: 'Не удалось загрузить список каталогов',
    signInGoogle: 'Google',
    anonymous: 'гость',
    authEnterCreds: 'Введите email и пароль',
    authSignedIn: 'Вход выполнен',
    authSignUpDone: 'Регистрация завершена. Проверьте почту',
    authSignedOut: 'Вы вышли',
    authConfigMissing: 'Supabase не настроен в config.js',
    authGoogleDisabled: 'Google OAuth отключен в Supabase',
    authNeedSignIn: 'Сначала выполните вход',
    authInvalidUserId: 'Неверный user id',
    authEnterUserId: 'Введите user id владельца каталога',
    authViewingUser: 'Просмотр каталога: {id}',
    authViewingOwn: 'Просмотр вашего каталога',
    authShareLinkCopied: 'Ссылка скопирована',
    readOnlyMode: 'Режим только просмотра',
    readOnlyEditorDisabled: 'Редактирование отключено в режиме просмотра чужого каталога',
    saveCloud: 'Сохранить в облако',
    cloudSaveProgress: 'Сохранение {current}/{total}',
    cloudSaveWriting: 'Сохранение в облако...',
    cloudSaveDoneShort: 'Сохранено',
    reloadCloud: 'Обновить',
    cloudSaved: 'Сохранено в облако',
    cloudSavedCount: 'Сохранено в облако: {n}',
    cloudSaveFailed: 'Ошибка сохранения',
    cloudReloaded: 'Обновлено из облака',
    cloudReloadedCount: 'Обновлено из облака: {n}',
    cloudLoadFailed: 'Ошибка загрузки из облака',
    cloudNotConfigured: 'Облачный режим не настроен',
    addPhotoUploaded: '{n} фото загружено в облако'
  },
  en: {
    loadJson: 'Load JSON',
    loadFolder: 'Load folder',
    loadImages: 'Load images',
    addPhoto: 'Add photo',
    addPhotoAdded: '{n} photos added',
    imagesLoaded: 'Images saved: {n}',
    folderImported: 'Folder loaded: {items} models, {images} images',
    folderJsonMissing: 'No JSON file found in selected folder',
    localImagesUnsupported: 'Browser does not support local image storage',
    sortByName: 'By name',
    sortByCode: 'By code',
    sortByYear: 'By year',
    editor: 'Editor',
    loadJsonPrompt: 'Load JSON',
    link: 'Link',
    code: 'Code',
    year: 'Year',
    file: 'File',
    errorInvalidJson: 'Error: invalid JSON',
    catalog: 'Catalog',
    preview: 'Preview',
    name: 'Name',
    copyJson: 'Copy JSON',
    saveJson: 'Download JSON',
    modelNamePlaceholder: 'Model name',
    yearPlaceholder: 'Year',
    codePlaceholder: 'Code',
    imagePlaceholder: '0.jpg',
    linkPlaceholder: 'https://...',
    noImage: 'no',
    loadJsonFirst: 'Load JSON first',
    jsonLoaded: 'JSON loaded',
    copiedToClipboard: 'Copied to clipboard',
    fileDownloaded: 'File downloaded',
    linkWord: 'LINK',
    pageTitle: 'Catalog',
    searchPlaceholder: 'Search by name, year, code...',
    searchNoResults: 'No results',
    favorites: 'Favorites',
    noFavorites: 'No favorites',
    similarModelsBadge: 'Also in other catalogs: {n}',
    similarModelsTitle: 'Available in other catalogs: {n}',
    infographic: 'Infographic',
    transpose: 'Transpose',
    yearModalTitle: 'Models for {year}',
    infographicModelCol: 'Model',
    infographicYearCol: 'Year',
    infographicChartCount: 'pcs',
    infographicChartLabel: 'Models per year',
    signIn: 'Sign in',
    authorize: 'Authorize',
    signUp: 'Sign up',
    signOut: 'Sign out',
    viewUserCatalog: 'Open user catalog',
    viewOwnCatalog: 'My catalog',
    copyShareLink: 'Copy share link',
    catalogOwner: 'Catalog',
    catalogOwnerLoading: 'Loading...',
    catalogOwnerMine: 'My catalog',
    catalogOwnerNoData: 'No catalogs available',
    catalogOwnerOnlyMine: 'Only your catalog is currently available',
    catalogOwnerLoadFailed: 'Failed to load catalog list',
    signInGoogle: 'Google',
    anonymous: 'anonymous',
    authEnterCreds: 'Enter email and password',
    authSignedIn: 'Signed in',
    authSignUpDone: 'Sign up completed. Check your email',
    authSignedOut: 'Signed out',
    authConfigMissing: 'Supabase config is missing in config.js',
    authGoogleDisabled: 'Google OAuth is disabled in Supabase',
    authNeedSignIn: 'Sign in first',
    authInvalidUserId: 'Invalid user id',
    authEnterUserId: 'Enter catalog owner user id',
    authViewingUser: 'Viewing catalog: {id}',
    authViewingOwn: 'Viewing your catalog',
    authShareLinkCopied: 'Link copied',
    readOnlyMode: 'Read-only mode',
    readOnlyEditorDisabled: 'Editing is disabled while viewing another user catalog',
    saveCloud: 'Save to cloud',
    cloudSaveProgress: 'Saving {current}/{total}',
    cloudSaveWriting: 'Saving to cloud...',
    cloudSaveDoneShort: 'Saved',
    reloadCloud: 'Reload',
    cloudSaved: 'Saved to cloud',
    cloudSavedCount: 'Saved to cloud: {n}',
    cloudSaveFailed: 'Save failed',
    cloudReloaded: 'Reloaded from cloud',
    cloudReloadedCount: 'Reloaded from cloud: {n}',
    cloudLoadFailed: 'Cloud load failed',
    cloudNotConfigured: 'Cloud mode is not configured',
    addPhotoUploaded: '{n} photos uploaded to cloud'
  },
  pt: {
    loadJson: 'Carregar JSON',
    loadFolder: 'Carregar pasta',
    loadImages: 'Carregar imagens',
    addPhoto: 'Adicionar foto',
    addPhotoAdded: '{n} fotos adicionadas',
    imagesLoaded: 'Imagens salvas: {n}',
    folderImported: 'Pasta carregada: {items} modelos, {images} imagens',
    folderJsonMissing: 'Nenhum JSON encontrado na pasta selecionada',
    localImagesUnsupported: 'O navegador não suporta armazenamento local de imagens',
    sortByName: 'Por nome',
    sortByCode: 'Por código',
    sortByYear: 'Por ano',
    editor: 'Editor',
    loadJsonPrompt: 'Carregue o JSON',
    link: 'Link',
    code: 'Código',
    year: 'Ano',
    file: 'Arquivo',
    errorInvalidJson: 'Erro: JSON inválido',
    catalog: 'Catálogo',
    preview: 'Pré-visualização',
    name: 'Nome',
    copyJson: 'Copiar JSON',
    saveJson: 'Baixar JSON',
    modelNamePlaceholder: 'Nome do modelo',
    yearPlaceholder: 'Ano',
    codePlaceholder: 'Código',
    imagePlaceholder: '0.jpg',
    linkPlaceholder: 'https://...',
    noImage: 'não',
    loadJsonFirst: 'Carregue o JSON primeiro',
    jsonLoaded: 'JSON carregado',
    copiedToClipboard: 'Copiado para a área de transferência',
    fileDownloaded: 'Arquivo baixado',
    linkWord: 'LINK',
    pageTitle: 'Catálogo',
    searchPlaceholder: 'Pesquisar por nome, ano, código...',
    searchNoResults: 'Nenhum resultado',
    favorites: 'Favoritos',
    noFavorites: 'Sem favoritos',
    similarModelsBadge: 'Tambem em outros: {n}',
    similarModelsTitle: 'Disponivel em outros catalogos: {n}',
    infographic: 'Infográfico',
    transpose: 'Transpor',
    yearModalTitle: 'Modelos de {year}',
    infographicModelCol: 'Modelo',
    infographicYearCol: 'Ano',
    infographicChartCount: 'un',
    infographicChartLabel: 'Modelos por ano',
    signIn: 'Entrar',
    authorize: 'Autorizar',
    signUp: 'Cadastrar',
    signOut: 'Sair',
    viewUserCatalog: 'Abrir catálogo de usuário',
    viewOwnCatalog: 'Meu catálogo',
    copyShareLink: 'Copiar link',
    catalogOwner: 'Catálogo',
    catalogOwnerLoading: 'Carregando...',
    catalogOwnerMine: 'Meu catálogo',
    catalogOwnerNoData: 'Nenhum catálogo disponível',
    catalogOwnerOnlyMine: 'Apenas seu catálogo está disponível no momento',
    catalogOwnerLoadFailed: 'Falha ao carregar a lista de catálogos',
    signInGoogle: 'Google',
    anonymous: 'anônimo',
    authEnterCreds: 'Informe email e senha',
    authSignedIn: 'Login realizado',
    authSignUpDone: 'Cadastro concluído. Verifique seu email',
    authSignedOut: 'Sessão encerrada',
    authConfigMissing: 'Supabase não configurado em config.js',
    authGoogleDisabled: 'Google OAuth está desativado no Supabase',
    authNeedSignIn: 'Faça login primeiro',
    authInvalidUserId: 'ID de usuário inválido',
    authEnterUserId: 'Informe o ID do proprietário do catálogo',
    authViewingUser: 'Visualizando catálogo: {id}',
    authViewingOwn: 'Visualizando seu catálogo',
    authShareLinkCopied: 'Link copiado',
    readOnlyMode: 'Modo somente leitura',
    readOnlyEditorDisabled: 'A edição está desativada ao visualizar o catálogo de outro usuário',
    saveCloud: 'Salvar na nuvem',
    cloudSaveProgress: 'Salvando {current}/{total}',
    cloudSaveWriting: 'Salvando na nuvem...',
    cloudSaveDoneShort: 'Salvo',
    reloadCloud: 'Recarregar',
    cloudSaved: 'Salvo na nuvem',
    cloudSavedCount: 'Salvo na nuvem: {n}',
    cloudSaveFailed: 'Falha ao salvar',
    cloudReloaded: 'Recarregado da nuvem',
    cloudReloadedCount: 'Recarregado da nuvem: {n}',
    cloudLoadFailed: 'Falha ao carregar da nuvem',
    cloudNotConfigured: 'Modo nuvem não configurado',
    addPhotoUploaded: '{n} fotos enviadas para a nuvem'
  }
};

// ─── Storage ────────────────────────────────────────────────────────────
function getLang() {
  try {
    let saved = localStorage.getItem(LANG_KEY);
    if (!saved) saved = localStorage.getItem('lang'); // migrate
    return LANG_VALID.includes(saved) ? saved : LANG_DEFAULT;
  } catch (e) {
    return LANG_DEFAULT;
  }
}

function setLang(lang) {
  try {
    if (LANG_VALID.includes(lang)) localStorage.setItem(LANG_KEY, lang);
  } catch (e) {  }
}

// ─── Helpers ─────────────────────────────────────────────────────────────
function t(key, replacements) {
  const lang = getLang();
  let str = TRANSLATIONS[lang]?.[key] ?? TRANSLATIONS.ru[key] ?? key;
  if (replacements) {
    Object.entries(replacements).forEach(([k, v]) => {
      str = str.replace(new RegExp(`\\{${k}\\}`, 'g'), String(v));
    });
  }
  return str;
}

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function applyTranslations() {
  document.querySelectorAll('[data-t]').forEach(el => {
    const key = el.getAttribute('data-t');
    el.textContent = t(key);
  });
}
